<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Solicitud de Ticket de Salida</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --azul: #004080;
      --azul-oscuro: #002244;
      --azul-claro: #f0f6ff;
      --gris: #f9f9f9;
      --borde: #004080;
      --texto: #1a1a1a;
      --exito: #2ecc71;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 20px;
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(rgba(240, 246, 255, 0.5), rgba(240, 246, 255, 0.5)), url('https://hjmintl.com/web/assets/images/003.jpg') no-repeat center center fixed;
      background-size: cover;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      min-height: 100vh;
    }
    .container {
      background-color: rgba(255, 255, 255, 0.85);
      padding: 35px 40px 25px;
      border-radius: 20px;
      max-width: 520px;
      width: 100%;
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.18);
      border: 6px solid var(--azul-oscuro);
      position: relative;
      backdrop-filter: saturate(180%) blur(10px);
    }
    .autocomplete-container {
      position: relative;
    }
    .autocomplete-items {
      position: absolute;
      border: 1px solid #d4d4d4;
      border-bottom: none;
      border-top: none;
      z-index: 99;
      top: 100%;
      left: 0;
      right: 0;
      max-height: 200px;
      overflow-y: auto;
    }
    .autocomplete-items div {
      padding: 10px;
      cursor: pointer;
      background-color: #fff;
      border-bottom: 1px solid #d4d4d4;
    }
    .autocomplete-items div:hover { background-color: #e9e9e9; }
    .logo {
      display: block;
      margin: 0 auto 30px;
      max-width: 160px;
      padding: 16px;
      border-radius: 20px;
      background: linear-gradient(145deg, #e6f0ff, #c0d1ff);
      box-shadow: 0 8px 20px rgba(0, 64, 128, 0.35), inset 0 0 10px rgba(255, 255, 255, 0.8);
      border: 2.5px solid #003366;
      transition: transform 0.3s ease;
    }
    .logo:hover {
      transform: scale(1.05);
      box-shadow: 0 12px 30px rgba(0, 64, 128, 0.5), inset 0 0 12px rgba(255, 255, 255, 0.9);
    }
    .titulo {
      text-align: center;
      font-size: 24px;
      color: var(--azul);
      margin: 0 0 30px 0;
      font-weight: 700;
    }
    label {
      font-weight: 600;
      margin: 12px 0 6px;
      display: block;
      color: var(--texto);
    }
    input[type="text"] {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: 1.5px solid #ccc;
      border-radius: 10px;
      background-color: #fff;
      transition: border 0.2s;
    }
    input[type="text"]:focus {
      border-color: var(--azul);
      outline: none;
    }
    .checkbox-container {
      margin-top: 18px;
      display: flex;
      align-items: center;
    }
    .checkbox-container input[type="checkbox"] {
      margin-right: 10px;
      width: 18px;
      height: 18px;
      cursor: pointer;
    }
    .vehiculo-transition {
      overflow: hidden;
      transition: max-height 0.4s ease, opacity 0.4s ease;
      max-height: 0;
      opacity: 0;
    }
    .vehiculo-transition.show {
      max-height: 100px;
      opacity: 1;
    }
    .btn-group {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }
    .btn-opcion {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1.5px solid var(--azul);
      background-color: white;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: var(--azul);
      transition: all 0.2s;
    }
    .btn-opcion.active {
      background-color: var(--azul);
      color: white;
    }
    #btnOtro, #btnOtroMotivo {
      background-color: #009688;
      color: white;
      border-color: #00796b;
      font-weight: 700;
    }
    #btnOtro:hover, #btnOtroMotivo:hover {
      background-color: #00796b;
      border-color: #004d40;
      color: white;
    }
    #otroDepartamentoBox, #otroMotivoBox {
      display: none;
    }
    button {
      width: 100%;
      padding: 16px;
      font-size: 17px;
      background-color: var(--azul);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      margin-top: 30px;
      transition: background-color 0.3s;
      font-weight: 600;
      letter-spacing: 0.03em;
    }
    button:disabled {
      background-color: #999;
      cursor: not-allowed;
    }
    #enviarDirectoBtn {
      background-color: #777;
      cursor: not-allowed;
    }
    button:hover:not(:disabled) {
      background-color: #003366;
    }
    .firma {
      text-align: center;
      font-size: 12px;
      color: #444;
      margin-top: 30px;
      opacity: 0.6;
      user-select: none;
      font-style: italic;
    }

#nombre::placeholder,
  #responsable::placeholder {
    font-size: 8px;
  }

  </style>
</head>
<body>
  <div class="container">
    <img src="https://hjmintl.com/web/storage/configs/logo.png" alt="Logo HJM" class="logo">
    <h2 class="titulo">Solicitud de Ticket de Salida</h2>

    <div class="autocomplete-container">
      <label for="nombre">Nombre del colaborador</label>
      <input id="nombre" type="text" required placeholder="Escriba o seleccione un nombre">
    </div>

    <div class="autocomplete-container">
      <label for="responsable">Responsable del Área</label>
      <input id="responsable" type="text" required placeholder="Escriba o seleccione un nombre">
    </div>

    <label>Departamento</label>
    <div class="btn-group" id="grupoDeptos">
      <div class="btn-opcion">Sistemas/MC</div>
      <div class="btn-opcion">Seguridad Patrimonial</div>
      <div class="btn-opcion">SDG</div>
      <div class="btn-opcion">TH</div>
      <div class="btn-opcion">Logística</div>
      <div class="btn-opcion">Taller</div>
      <div class="btn-opcion">Facturación</div>
      <div class="btn-opcion">GyT</div>
      <div class="btn-opcion">CEA</div>
      <div class="btn-opcion">Servicio al Cliente</div>
      <div class="btn-opcion">Operador</div>
      <div class="btn-opcion" id="btnOtro">Otro departamento</div>
    </div>
    <input id="otroDepartamentoBox" type="text" placeholder="Especificar otro departamento">

    <label>Motivo de la salida</label>
    <div class="btn-group" id="grupoMotivos">
      <div class="btn-opcion">Comida/Lonchera</div>
      <div class="btn-opcion">Oxxo</div>
      <div class="btn-opcion" id="btnOtroMotivo">Otro motivo</div>
    </div>
    <input id="otroMotivoBox" type="text" placeholder="Especificar otro motivo">

    <div class="checkbox-container">
      <input type="checkbox" id="chkVehiculo">
      <label for="chkVehiculo" style="margin: 0;">Vehículo utilitario</label>
    </div>
    <div id="vehiculoBox" class="vehiculo-transition">
      <input id="vehiculo" type="text" placeholder="Modelo del vehículo">
    </div>
    <button id="enviarBtn">Enviar solicitud</button>
    <div class="firma">by Santos Lp</div>
  </div>

  <script>
    let botToken = "";
    let grupoSolicitudes = "";

    const backendUrl = 'https://slp166.pythonanywhere.com';

    fetch(`${backendUrl}/tok.dat`)
      .then(r => r.text())
      .then(text => {
        const data = JSON.parse(atob(text.trim()));
        botToken = data.botToken;
        grupoSolicitudes = data.chat_id;
      })
      .catch((err) => {
        console.error("No se pudo cargar la configuración inicial desde el servidor. Error: " + err.message);
      });

    let nombresEmpleados = [];
    const sheetId = '1NE7c3oi8lIxLmIitiizU8QGPOJ_yWxuNH7-gcIFHc9k';
    const sheetUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:json`;

    fetch(sheetUrl)
      .then(res => res.text())
      .then(text => {
        const json = JSON.parse(text.substring(47).slice(0, -2));
        nombresEmpleados = json.table.rows
          .slice(1)
          .map(row => (row.c[2] && row.c[2].v) ? row.c[2].v.trim() : null)
          .filter(name => name);
        console.log("Nombres cargados:", nombresEmpleados);
      })
      .catch(err => console.error("Error al cargar nombres del Google Sheet:", err));

    function setupAutocomplete(inputElement) {
      let currentFocus;
      inputElement.addEventListener("input", function(e) {
        let list, item, val = this.value;
        closeAllLists();
        if (!val) { return false; }
        currentFocus = -1;
        list = document.createElement("DIV");
        list.setAttribute("id", this.id + "autocomplete-list");
        list.setAttribute("class", "autocomplete-items");
        this.parentNode.appendChild(list);

        nombresEmpleados.forEach(nombre => {
          if (nombre.toUpperCase().includes(val.toUpperCase())) {
            item = document.createElement("DIV");
            item.innerHTML = "<strong>" + nombre.substr(0, val.length) + "</strong>";
            item.innerHTML += nombre.substr(val.length);
            item.innerHTML += "<input type='hidden' value='" + nombre + "'>";
            item.addEventListener("click", function(e) {
              inputElement.value = this.getElementsByTagName("input")[0].value;
              closeAllLists();
            });
            list.appendChild(item);
          }
        });
      });

      function closeAllLists(elmnt) {
        const items = document.getElementsByClassName("autocomplete-items");
        for (let i = 0; i < items.length; i++) {
          if (elmnt != items[i] && elmnt != inputElement) {
            items[i].parentNode.removeChild(items[i]);
          }
        }
      }

      document.addEventListener("click", function (e) {
        closeAllLists(e.target);
      });
    }

    setupAutocomplete(document.getElementById("nombre"));
    setupAutocomplete(document.getElementById("responsable"));

    const opciones = document.querySelectorAll("#grupoDeptos .btn-opcion");
    let departamentoSeleccionado = "";
    opciones.forEach(btn => {
      btn.addEventListener("click", () => {
        opciones.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        if (btn.id === "btnOtro") {
          document.getElementById("otroDepartamentoBox").style.display = "block";
          departamentoSeleccionado = "";
        } else {
          document.getElementById("otroDepartamentoBox").style.display = "none";
          document.getElementById("otroDepartamentoBox").value = "";
          departamentoSeleccionado = btn.textContent;
        }
      });
    });

    const btnsMotivos = document.querySelectorAll('#grupoMotivos .btn-opcion');
    let motivoSeleccionado = "";

    btnsMotivos.forEach(btn => {
      btn.addEventListener("click", () => {
        btnsMotivos.forEach(b => b.classList.remove("active"));
        btn.classList.add("active");

        if (btn.id === "btnOtroMotivo") {
          document.getElementById("otroMotivoBox").style.display = "block";
          motivoSeleccionado = "";
        } else {
          document.getElementById("otroMotivoBox").style.display = "none";
          document.getElementById("otroMotivoBox").value = "";
          motivoSeleccionado = btn.textContent;
        }
      });
    });

    document.getElementById("chkVehiculo").addEventListener("change", function () {
      const vehiculoBox = document.getElementById("vehiculoBox");
      this.checked ? vehiculoBox.classList.add("show") : vehiculoBox.classList.remove("show");
    });

    document.getElementById("enviarBtn").addEventListener("click", async () => {
      const nombre = document.getElementById("nombre").value.trim();
      const responsable = document.getElementById("responsable").value.trim();
      const chkVehiculo = document.getElementById("chkVehiculo").checked;
      const vehiculo = chkVehiculo ? document.getElementById("vehiculo").value.trim() : "NO APLICA";
      const otroDepto = document.getElementById("otroDepartamentoBox").value.trim();
      const departamento = departamentoSeleccionado || otroDepto;
      const otroMotivo = document.getElementById("otroMotivoBox").value.trim();
      const motivo = motivoSeleccionado || otroMotivo;

      if (!nombre || !departamento || !motivo || !responsable || (chkVehiculo && !vehiculo)) {
        alert("Por favor completa todos los campos requeridos.");
        return;
      }

      const fechaHora = new Date();
      const dd = String(fechaHora.getDate()).padStart(2, '0');
      const mm = String(fechaHora.getMonth() + 1).padStart(2, '0');
      const yyyy = fechaHora.getFullYear();
      const hh = String(fechaHora.getHours()).padStart(2, '0');
      const min = String(fechaHora.getMinutes()).padStart(2, '0');
      const ss = String(fechaHora.getSeconds()).padStart(2, '0');
      
      const fechaHoraStr = `${dd}/${mm}/${yyyy} ${hh}:${min}`;
      const folio = `HJM-${nombre.replace(/\s+/g, "").toUpperCase()}-${yyyy}${mm}${dd}-${hh}${min}${ss}`;

      const mensaje = `📢 SOLICITUD DE TICKET DE SALIDA\n\n👤 Colaborador: ${nombre}\n👤 Responsable: ${responsable}\n🏢 Departamento: ${departamento}\n🚗 Vehículo utilitario: ${vehiculo}\n📝 Motivo: ${motivo}\n⏰ Fecha/Hora: ${fechaHoraStr}\n🔢 Folio: ${folio}\n`;

      const btn = document.getElementById("enviarBtn");
      btn.disabled = true;
      btn.textContent = "Enviando...";

      const payload = { 
        chat_id: grupoSolicitudes, 
        text: mensaje, 
        reply_markup: { inline_keyboard: [[{ text: "Aprobar", callback_data: "APROBADO " + folio }, { text: "Rechazar", callback_data: "RECHAZADO " + folio }]] } 
      };

      try {
        const response = await fetch(`${backendUrl}/api/enviar_telegram`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (!response.ok) {
          throw new Error(`Error del servidor: ${response.statusText}`);
        }

        alert("✅ Solicitud enviada con folio: " + folio);

      } catch (pythonError) {
        console.warn("Fallo al enviar con el backend de Python:", pythonError.message);
        
        try {
          const phpProxyUrl = 'http://hjmintl.com/telegram_proxy.php';
          const fallbackResponse = await fetch(phpProxyUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
          });

          if (!fallbackResponse.ok) throw new Error('El método de respaldo también falló.');

          alert("✅ Solicitud enviada con folio (vía respaldo): " + folio);

        } catch (phpError) {
          console.error("Fallo al enviar con el proxy PHP:", phpError.message);
          alert("🚫 Error: Ambos métodos de envío fallaron. Por favor, revisa tu conexión o contacta al administrador.");
        }
      } finally {
        btn.disabled = false;
        btn.textContent = "Enviar solicitud";
      }
    });
  </script>
</body>
</html>



